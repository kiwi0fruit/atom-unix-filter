"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const atom_1 = require("atom");
const CP = require("child_process");
let subs;
exports.config = {
    command: {
        type: 'string',
        default: 'cat',
    },
    runOnSave: {
        type: 'boolean',
        default: false,
    },
};
function activate() {
    subs = new atom_1.CompositeDisposable();
    subs.add(atom.commands.add('atom-text-editor', {
        'unix-filter:run': ({ currentTarget }) => {
            run(currentTarget.getModel()).catch((e) => {
                console.error(e);
            });
        },
        'unix-filter:exec': async ({ currentTarget }) => {
            const textEditorElement = document.createElement('atom-text-editor');
            textEditorElement.setAttribute('mini', '');
            const panel = atom.workspace.addModalPanel({
                item: textEditorElement,
                visible: true,
            });
            textEditorElement.focus();
            const disp = new atom_1.CompositeDisposable();
            const cont = await new Promise((resolve) => {
                disp.add(atom.commands.add(textEditorElement, {
                    'core:confirm': () => resolve(true),
                    'core:cancel': () => resolve(false),
                }));
            });
            disp.dispose();
            panel.destroy();
            if (cont) {
                const cmd = textEditorElement.getModel().getText();
                customCommand(currentTarget.getModel(), cmd).catch((e) => {
                    console.error(e);
                });
            }
        },
    }), atom.workspace.observeTextEditors((editor) => {
        const buf = editor.getBuffer();
        const disp = new atom_1.CompositeDisposable();
        disp.add(buf.onWillSave(async () => {
            const shouldRun = atom.config.get('unix-filter.runOnSave', {
                scope: editor.getRootScopeDescriptor(),
            });
            if (shouldRun)
                return run(editor);
            else
                return;
        }), buf.onDidDestroy(() => {
            subs.remove(disp);
            disp.dispose();
        }));
        subs.add(disp);
    }));
}
exports.activate = activate;
function deactivate() {
    subs.dispose();
}
exports.deactivate = deactivate;
async function run(editor) {
    const cmd = atom.config.get('unix-filter.command', {
        scope: editor.getRootScopeDescriptor(),
    });
    return customCommand(editor, cmd);
}
async function customCommand(editor, cmd) {
    const text = editor.getText();
    return new Promise((resolve) => {
        const proc = CP.exec(cmd, { encoding: 'utf8' }, (error, result) => {
            if (error) {
                atom.notifications.addError(error.toString(), {
                    detail: error.message,
                    stack: error.stack,
                    dismissable: true,
                });
                resolve();
            }
            else {
                const [first, ...points] = editor
                    .getCursors()
                    .map((c) => c.getBufferPosition());
                editor.setText(result.replace(/^ +$/gm, ''));
                editor.setCursorBufferPosition(first);
                points.forEach((p) => editor.addCursorAtBufferPosition(p));
                resolve();
            }
        });
        proc.stdin.write(text);
        proc.stdin.end();
    });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFpbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9tYWluLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsK0JBQXNEO0FBQ3RELG9DQUFtQztBQUVuQyxJQUFJLElBQXlCLENBQUE7QUFFaEIsUUFBQSxNQUFNLEdBQUc7SUFDcEIsT0FBTyxFQUFFO1FBQ1AsSUFBSSxFQUFFLFFBQVE7UUFDZCxPQUFPLEVBQUUsS0FBSztLQUNmO0lBQ0QsU0FBUyxFQUFFO1FBQ1QsSUFBSSxFQUFFLFNBQVM7UUFDZixPQUFPLEVBQUUsS0FBSztLQUNmO0NBQ0YsQ0FBQTtBQUVEO0lBQ0UsSUFBSSxHQUFHLElBQUksMEJBQW1CLEVBQUUsQ0FBQTtJQUNoQyxJQUFJLENBQUMsR0FBRyxDQUNOLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLGtCQUFrQixFQUFFO1FBQ3BDLGlCQUFpQixFQUFFLENBQUMsRUFBRSxhQUFhLEVBQUUsRUFBRSxFQUFFO1lBQ3ZDLEdBQUcsQ0FBQyxhQUFhLENBQUMsUUFBUSxFQUFFLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRTtnQkFDeEMsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQTtZQUNsQixDQUFDLENBQUMsQ0FBQTtRQUNKLENBQUM7UUFFRCxrQkFBa0IsRUFBRSxLQUFLLEVBQUUsRUFBRSxhQUFhLEVBQUUsRUFBRSxFQUFFO1lBQzlDLE1BQU0saUJBQWlCLEdBQUcsUUFBUSxDQUFDLGFBQWEsQ0FBQyxrQkFBa0IsQ0FBQyxDQUFBO1lBQ3BFLGlCQUFpQixDQUFDLFlBQVksQ0FBQyxNQUFNLEVBQUUsRUFBRSxDQUFDLENBQUE7WUFDMUMsTUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxhQUFhLENBQUM7Z0JBQ3pDLElBQUksRUFBRSxpQkFBaUI7Z0JBQ3ZCLE9BQU8sRUFBRSxJQUFJO2FBQ2QsQ0FBQyxDQUFBO1lBQ0YsaUJBQWlCLENBQUMs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RUFBRSxDQUFDLEtBQUssRUFBRSxNQUFNLEVBQUUsRUFBRTtZQUNoRSxFQUFFLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDO2dCQUNWLElBQUksQ0FBQyxhQUFhLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxRQUFRLEVBQUUsRUFBRTtvQkFDNUMsTUFBTSxFQUFFLEtBQUssQ0FBQyxPQUFPO29CQUNyQixLQUFLLEVBQUUsS0FBSyxDQUFDLEtBQUs7b0JBQ2xCLFdBQVcsRUFBRSxJQUFJO2lCQUNsQixDQUFDLENBQUE7Z0JBQ0YsT0FBTyxFQUFFLENBQUE7WUFDWCxDQUFDO1lBQUMsSUFBSSxDQUFDLENBQUM7Z0JBQ04sTUFBTSxDQUFDLEtBQUssRUFBRSxHQUFHLE1BQU0sQ0FBQyxHQUFHLE1BQU07cUJBQzlCLFVBQVUsRUFBRTtxQkFDWixHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxpQkFBaUIsRUFBRSxDQUFDLENBQUE7Z0JBQ3BDLE1BQU0sQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxRQUFRLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQTtnQkFDNUMsTUFBTSxDQUFDLHVCQUF1QixDQUFDLEtBQUssQ0FBQyxDQUFBO2dCQUNyQyxNQUFNLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxNQUFNLENBQUMseUJBQXlCLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQTtnQkFDMUQsT0FBTyxFQUFFLENBQUE7WUFDWCxDQUFDO1FBQ0gsQ0FBQyxDQUFDLENBQUE7UUFDRixJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQTtRQUN0QixJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsRUFBRSxDQUFBO0lBQ2xCLENBQUMsQ0FBQyxDQUFBO0FBQ0osQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbXBvc2l0ZURpc3Bvc2FibGUsIFRleHRFZGl0b3IgfSBmcm9tICdhdG9tJ1xuaW1wb3J0ICogYXMgQ1AgZnJvbSAnY2hpbGRfcHJvY2VzcydcblxubGV0IHN1YnM6IENvbXBvc2l0ZURpc3Bvc2FibGVcblxuZXhwb3J0IGNvbnN0IGNvbmZpZyA9IHtcbiAgY29tbWFuZDoge1xuICAgIHR5cGU6ICdzdHJpbmcnLFxuICAgIGRlZmF1bHQ6ICdjYXQnLFxuICB9LFxuICBydW5PblNhdmU6IHtcbiAgICB0eXBlOiAnYm9vbGVhbicsXG4gICAgZGVmYXVsdDogZmFsc2UsXG4gIH0sXG59XG5cbmV4cG9ydCBmdW5jdGlvbiBhY3RpdmF0ZSgpIHtcbiAgc3VicyA9IG5ldyBDb21wb3NpdGVEaXNwb3NhYmxlKClcbiAgc3Vicy5hZGQoXG4gICAgYXRvbS5jb21tYW5kcy5hZGQoJ2F0b20tdGV4dC1lZGl0b3InLCB7XG4gICAgICAndW5peC1maWx0ZXI6cnVuJzogKHsgY3VycmVudFRhcmdldCB9KSA9PiB7XG4gICAgICAgIHJ1bihjdXJyZW50VGFyZ2V0LmdldE1vZGVsKCkpLmNhdGNoKChlKSA9PiB7XG4gICAgICAgICAgY29uc29sZS5lcnJvcihlKVxuICAgICAgICB9KVxuICAgICAgfSxcbiAgICAgIC8vIFRPRE86IGF0b20tc2VsZWN0LWxpc3Qgd2l0aCBoaXN0b3J5XG4gICAgICAndW5peC1maWx0ZXI6ZXhlYyc6IGFzeW5jICh7IGN1cnJlbnRUYXJnZXQgfSkgPT4ge1xuICAgICAgICBjb25zdCB0ZXh0RWRpdG9yRWxlbWVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2F0b20tdGV4dC1lZGl0b3InKVxuICAgICAgICB0ZXh0RWRpdG9yRWxlbWVudC5zZXRBdHRyaWJ1dGUoJ21pbmknLCAnJylcbiAgICAgICAgY29uc3QgcGFuZWwgPSBhdG9tLndvcmtzcGFjZS5hZGRNb2RhbFBhbmVsKHtcbiAgICAgICAgICBpdGVtOiB0ZXh0RWRpdG9yRWxlbWVudCxcbiAgICAgICAgICB2aXNpYmxlOiB0cnVlLFxuICAgICAgICB9KVxuICAgICAgICB0ZXh0RWRpdG9yRWxlbWVudC5mb2N1cygpXG4gICAgICAgIGNvbnN0IGRpc3AgPSBuZXcgQ29tcG9zaXRlRGlzcG9zYWJsZSgpXG4gICAgICAgIGNvbnN0IGNvbnQgPSBhd2FpdCBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4ge1xuICAgICAgICAgIGRpc3AuYWRkKFxuICAgICAgICAgICAgYXRvbS5jb21tYW5kcy5hZGQodGV4dEVkaXRvckVsZW1lbnQsIHtcbiAgICAgICAgICAgICAgJ2NvcmU6Y29uZmlybSc6ICgpID0+IHJlc29sdmUodHJ1ZSksXG4gICAgICAgICAgICAgICdjb3JlOmNhbmNlbCc6ICgpID0+IHJlc29sdmUoZmFsc2UpLFxuICAgICAgICAgICAgfSksXG4gICAgICAgICAgKVxuICAgICAgICB9KVxuICAgICAgICBkaXNwLmRpc3Bvc2UoKVxuICAgICAgICBwYW5lbC5kZXN0cm95KClcbiAgICAgICAgaWYgKGNvbnQpIHtcbiAgICAgICAgICBjb25zdCBjbWQgPSB0ZXh0RWRpdG9yRWxlbWVudC5nZXRNb2RlbCgpLmdldFRleHQoKVxuICAgICAgICAgIGN1c3RvbUNvbW1hbmQoY3VycmVudFRhcmdldC5nZXRNb2RlbCgpLCBjbWQpLmNhdGNoKChlKSA9PiB7XG4gICAgICAgICAgICBjb25zb2xlLmVycm9yKGUpXG4gICAgICAgICAgfSlcbiAgICAgICAgfVxuICAgICAgfSxcbiAgICB9KSxcbiAgICBhdG9tLndvcmtzcGFjZS5vYnNlcnZlVGV4dEVkaXRvcnMoKGVkaXRvcikgPT4ge1xuICAgICAgY29uc3QgYnVmID0gZWRpdG9yLmdldEJ1ZmZlcigpXG4gICAgICBjb25zdCBkaXNwID0gbmV3IENvbXBvc2l0ZURpc3Bvc2FibGUoKVxuICAgICAgZGlzcC5hZGQoXG4gICAgICAgIGJ1Zi5vbldpbGxTYXZlKGFzeW5jICgpID0+IHtcbiAgICAgICAgICBjb25zdCBzaG91bGRSdW4gPSBhdG9tLmNvbmZpZy5nZXQoJ3VuaXgtZmlsdGVyLnJ1bk9uU2F2ZScsIHtcbiAgICAgICAgICAgIHNjb3BlOiBlZGl0b3IuZ2V0Um9vdFNjb3BlRGVzY3JpcHRvcigpLFxuICAgICAgICAgIH0pXG4gICAgICAgICAgaWYgKHNob3VsZFJ1bikgcmV0dXJuIHJ1bihlZGl0b3IpXG4gICAgICAgICAgZWxzZSByZXR1cm5cbiAgICAgICAgfSksXG4gICAgICAgIGJ1Zi5vbkRpZERlc3Ryb3koKCkgPT4ge1xuICAgICAgICAgIHN1YnMucmVtb3ZlKGRpc3ApXG4gICAgICAgICAgZGlzcC5kaXNwb3NlKClcbiAgICAgICAgfSksXG4gICAgICApXG4gICAgICBzdWJzLmFkZChkaXNwKVxuICAgIH0pLFxuICApXG59XG5cbmV4cG9ydCBmdW5jdGlvbiBkZWFjdGl2YXRlKCkge1xuICBzdWJzLmRpc3Bvc2UoKVxufVxuXG5hc3luYyBmdW5jdGlvbiBydW4oZWRpdG9yOiBUZXh0RWRpdG9yKSB7XG4gIGNvbnN0IGNtZCA9IGF0b20uY29uZmlnLmdldCgndW5peC1maWx0ZXIuY29tbWFuZCcsIHtcbiAgICBzY29wZTogZWRpdG9yLmdldFJvb3RTY29wZURlc2NyaXB0b3IoKSxcbiAgfSlcbiAgcmV0dXJuIGN1c3RvbUNvbW1hbmQoZWRpdG9yLCBjbWQpXG59XG5cbmFzeW5jIGZ1bmN0aW9uIGN1c3RvbUNvbW1hbmQoZWRpdG9yOiBUZXh0RWRpdG9yLCBjbWQ6IHN0cmluZykge1xuICBjb25zdCB0ZXh0ID0gZWRpdG9yLmdldFRleHQoKVxuICByZXR1cm4gbmV3IFByb21pc2U8dm9pZD4oKHJlc29sdmUpID0+IHtcbiAgICBjb25zdCBwcm9jID0gQ1AuZXhlYyhjbWQsIHsgZW5jb2Rpbmc6ICd1dGY4JyB9LCAoZXJyb3IsIHJlc3VsdCkgPT4ge1xuICAgICAgaWYgKGVycm9yKSB7XG4gICAgICAgIGF0b20ubm90aWZpY2F0aW9ucy5hZGRFcnJvcihlcnJvci50b1N0cmluZygpLCB7XG4gICAgICAgICAgZGV0YWlsOiBlcnJvci5tZXNzYWdlLFxuICAgICAgICAgIHN0YWNrOiBlcnJvci5zdGFjayxcbiAgICAgICAgICBkaXNtaXNzYWJsZTogdHJ1ZSxcbiAgICAgICAgfSlcbiAgICAgICAgcmVzb2x2ZSgpIC8vIGFsd2F5cyBzYXZlIHRoZSBmaWxlIVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY29uc3QgW2ZpcnN0LCAuLi5wb2ludHNdID0gZWRpdG9yXG4gICAgICAgICAgLmdldEN1cnNvcnMoKVxuICAgICAgICAgIC5tYXAoKGMpID0+IGMuZ2V0QnVmZmVyUG9zaXRpb24oKSlcbiAgICAgICAgZWRpdG9yLnNldFRleHQocmVzdWx0LnJlcGxhY2UoL14gKyQvZ20sICcnKSlcbiAgICAgICAgZWRpdG9yLnNldEN1cnNvckJ1ZmZlclBvc2l0aW9uKGZpcnN0KVxuICAgICAgICBwb2ludHMuZm9yRWFjaCgocCkgPT4gZWRpdG9yLmFkZEN1cnNvckF0QnVmZmVyUG9zaXRpb24ocCkpXG4gICAgICAgIHJlc29sdmUoKVxuICAgICAgfVxuICAgIH0pXG4gICAgcHJvYy5zdGRpbi53cml0ZSh0ZXh0KVxuICAgIHByb2Muc3RkaW4uZW5kKClcbiAgfSlcbn1cbiJdfQ==