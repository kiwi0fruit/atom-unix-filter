"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const atom_1 = require("atom");
const CP = require("child_process");
let subscriptions;
exports.config = {
    command: {
        type: 'string',
        default: 'cat',
    },
    runOnSave: {
        type: 'boolean',
        default: false,
    },
};
function activate() {
    subscriptions = new atom_1.CompositeDisposable();
    subscriptions.add(atom.commands.add('atom-text-editor', {
        'unix-filter:run': ({ currentTarget }) => {
            run(currentTarget.getModel()).catch((e) => {
                console.error(e);
            });
        },
        'unix-filter:exec': async ({ currentTarget }) => {
            const textEditorElement = document.createElement('atom-text-editor');
            textEditorElement.setAttribute('mini', '');
            const panel = atom.workspace.addModalPanel({
                item: textEditorElement,
                visible: true,
            });
            textEditorElement.focus();
            const disp = new atom_1.CompositeDisposable();
            const cont = await new Promise((resolve) => {
                disp.add(atom.commands.add(textEditorElement, {
                    'core:confirm': () => resolve(true),
                    'core:cancel': () => resolve(false),
                }));
            });
            disp.dispose();
            panel.destroy();
            if (cont) {
                const cmd = textEditorElement.getModel().getText();
                customCommand(currentTarget.getModel(), cmd).catch((e) => {
                    console.error(e);
                });
            }
        },
    }), atom.workspace.observeTextEditors((editor) => {
        const buf = editor.getBuffer();
        const disp = buf.onWillSave(async () => {
            const shouldRun = atom.config.get('unix-filter.runOnSave', {
                scope: editor.getLastCursor().getScopeDescriptor(),
            });
            if (shouldRun)
                return run(editor);
            else
                return;
        });
        buf.onDidDestroy(() => {
            subscriptions.remove(disp);
            disp.dispose();
        });
    }));
}
exports.activate = activate;
function deactivate() {
    subscriptions.dispose();
}
exports.deactivate = deactivate;
async function run(editor) {
    const cmd = atom.config.get('unix-filter.command', {
        scope: editor.getLastCursor().getScopeDescriptor(),
    });
    return customCommand(editor, cmd);
}
async function customCommand(editor, cmd) {
    const text = editor.getText();
    return new Promise((resolve) => {
        const proc = CP.exec(cmd, { encoding: 'utf8' }, (error, result) => {
            if (error) {
                atom.notifications.addError(error.toString(), {
                    detail: error.message,
                    stack: error.stack,
                    dismissable: true,
                });
                resolve();
            }
            else {
                const [first, ...points] = editor
                    .getCursors()
                    .map((c) => c.getBufferPosition());
                editor.setText(result.replace(/^ +$/gm, ''));
                editor.setCursorBufferPosition(first);
                points.forEach((p) => editor.addCursorAtBufferPosition(p));
                resolve();
            }
        });
        proc.stdin.write(text);
        proc.stdin.end();
    });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFpbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9tYWluLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsK0JBQXNEO0FBQ3RELG9DQUFtQztBQUVuQyxJQUFJLGFBQWtDLENBQUE7QUFFekIsUUFBQSxNQUFNLEdBQUc7SUFDcEIsT0FBTyxFQUFFO1FBQ1AsSUFBSSxFQUFFLFFBQVE7UUFDZCxPQUFPLEVBQUUsS0FBSztLQUNmO0lBQ0QsU0FBUyxFQUFFO1FBQ1QsSUFBSSxFQUFFLFNBQVM7UUFDZixPQUFPLEVBQUUsS0FBSztLQUNmO0NBQ0YsQ0FBQTtBQUVEO0lBQ0UsYUFBYSxHQUFHLElBQUksMEJBQW1CLEVBQUUsQ0FBQTtJQUN6QyxhQUFhLENBQUMsR0FBRyxDQUNmLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLGtCQUFrQixFQUFFO1FBQ3BDLGlCQUFpQixFQUFFLENBQUMsRUFBRSxhQUFhLEVBQUUsRUFBRSxFQUFFO1lBQ3ZDLEdBQUcsQ0FBQyxhQUFhLENBQUMsUUFBUSxFQUFFLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRTtnQkFDeEMsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQTtZQUNsQixDQUFDLENBQUMsQ0FBQTtRQUNKLENBQUM7UUFFRCxrQkFBa0IsRUFBRSxLQUFLLEVBQUUsRUFBRSxhQUFhLEVBQUUsRUFBRSxFQUFFO1lBQzlDLE1BQU0saUJBQWlCLEdBQUcsUUFBUSxDQUFDLGFBQWEsQ0FBQyxrQkFBa0IsQ0FBQyxDQUFBO1lBQ3BFLGlCQUFpQixDQUFDLFlBQVksQ0FBQyxNQUFNLEVBQUUsRUFBRSxDQUFDLENBQUE7WUFDMUMsTUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxhQUFhLENBQUM7Z0JBQ3pDLElBQUksRUFBRSxpQkFBaUI7Z0JBQ3ZCLE9BQU8sRUFBRSxJQUFJO2FBQ2QsQ0FBQyxDQUFBO1lBQ0YsaUJBQWlCLENBQUMsS0FBSyxFQUFFLENBQUE7WUFDekIsTUFBTSxJQUFJLEdBQUcsSUFBSSwwQkFBbUIsRUFBRSxDQUFBO1lBQ3RDLE1BQU0sSUFBSSxHQUFHLE1BQU0sSUFBSSxPQUFPLENBQUMsQ0FBQyxPQUFPLEVBQUUsRUFBRTtnQkFDekMsSUFBSSxDQUFDLEdBQUcsQ0FDTixJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxpQkFBaUIsRUFBRTtvQkFDbkMsY0FBYyxFQUFFLEdBQUcsRUFBRSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUM7b0JBQ25DLGFBQWEsRUFBRSxHQUFHLEVBQUUsQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDO2lCQUNwQyxDQUFDLENBQ0gsQ0FBQTtZQUNILENBQUMsQ0FBQyxDQUFBO1lBQ0YsSUFBSSxDQUFDLE9BQU8sRUFBRSxDQUFBO1lBQ2QsS0FBSyxDQUFDLE9BQU8sRUFBRSxDQUFBO1lBQ2YsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztnQkFDVCxNQUFNLEdBQUcsR0FBRyxpQkFBaUIsQ0FBQyxRQUFRLEVBQUUsQ0FBQyxPQUFPLEVBQUUsQ0FBQTtnQkFDbEQsYUFBYSxDQUFDLGFBQWEsQ0FBQyxRQUFRLEVBQUUsRUFBRSxHQUFHLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRTtvQkFDdkQsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQTtnQkFDbEIsQ0FBQyxDQUFDLENBQUE7WUFDSixDQUFDO1FBQ0gsQ0FBQztLQUNGLENBQUMsRUFDRixJQUFJLENBQUMsU0FBUyxDQUFDLGtCQUFrQixDQUFDLENBQUMsTUFBTSxFQUFFLEVBQUU7UUFDM0MsTUFBTSxHQUFHLEdBQUcsTUFBTSxDQUFDLFNBQVMsRUFBRSxDQUFBO1FBQzlCLE1BQU0sSUFBSSxHQUFHLEdBQUcsQ0FBQyxVQUFVLENBQUMsS0FBSyxJQUFJLEVBQUU7WUFDckMsTUFBTSxTQUFTLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsdUJBQXVCLEVBQUU7Z0JBQ3pELEtBQUssRUFBRSxNQUFNLENBQUMsYUFBYSxFQUFFLENBQUMsa0JBQWtCLEVBQUU7YUFDbkQsQ0FBQyxDQUFBO1lBQ0YsRUFBRSxDQUFDLENBQUMsU0FBUyxDQUFDO2dCQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLENBQUE7WUFDakMsSUFBSTtnQkFBQyxNQUFNLENBQUE7UUFDYixDQUFDLENBQUMsQ0FBQTtRQUNGLEdBQUcsQ0FBQyxZQUFZLENBQUMsR0FBRyxFQUFFO1lBQ3BCLGFBQWEsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUE7WUFDMUIsSUFBSSxDQUFDLE9BQU8sRUFBRSxDQUFBO1FBQ2hCLENBQUMsQ0FBQyxDQUFBO0lBQ0osQ0FBQyxDQUFDLENBQ0gsQ0FBQTtBQUNILENBQUM7QUFwREQsNEJBb0RDO0FBRUQ7SUFDRSxhQUFhLENBQUMsT0FBTyxFQUFFLENBQUE7QUFDekIsQ0FBQztBQUZELGdDQUVDO0FBRUQsS0FBSyxjQUFjLE1BQWtCO0lBQ25DLE1BQU0sR0FBRyxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLHFCQUFxQixFQUFFO1FBQ2pELEtBQUssRUFBRSxNQUFNLENBQUMsYUFBYSxFQUFFLENBQUMsa0JBQWtCLEVBQUU7S0FDbkQsQ0FBQyxDQUFBO0lBQ0YsTUFBTSxDQUFDLGFBQWEsQ0FBQyxNQUFNLEVBQUUsR0FBRyxDQUFDLENBQUE7QUFDbkMsQ0FBQztBQUVELEtBQUssd0JBQXdCLE1BQWtCLEVBQUUsR0FBVztJQUMxRCxNQUFNLElBQUksR0FBRyxNQUFNLENBQUMsT0FBTyxFQUFFLENBQUE7SUFDN0IsTUFBTSxDQUFDLElBQUksT0FBTyxDQUFPLENBQUMsT0FBTyxFQUFFLEVBQUU7UUFDbkMsTUFBTSxJQUFJLEdBQUcsRUFBRSxDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUUsRUFBRSxRQUFRLEVBQUUsTUFBTSxFQUFFLEVBQUUsQ0FBQyxLQUFLLEVBQUUsTUFBTSxFQUFFLEVBQUU7WUFDaEUsRUFBRSxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztnQkFDVixJQUFJLENBQUMsYUFBYSxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsUUFBUSxFQUFFLEVBQUU7b0JBQzVDLE1BQU0sRUFBRSxLQUFLLENBQUMsT0FBTztvQkFDckIsS0FBSyxFQUFFLEtBQUssQ0FBQyxLQUFLO29CQUNsQixXQUFXLEVBQUUsSUFBSTtpQkFDbEIsQ0FBQyxDQUFBO2dCQUNGLE9BQU8sRUFBRSxDQUFBO1lBQ1gsQ0FBQztZQUFDLElBQUksQ0FBQyxDQUFDO2dCQUNOLE1BQU0sQ0FBQyxLQUFLLEVBQUUsR0FBRyxNQUFNLENBQUMsR0FBRyxNQUFNO3FCQUM5QixVQUFVLEVBQUU7cUJBQ1osR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsaUJBQWlCLEVBQUUsQ0FBQyxDQUFBO2dCQUNwQyxNQUFNLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsUUFBUSxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUE7Z0JBQzVDLE1BQU0sQ0FBQyx1QkFBdUIsQ0FBQyxLQUFLLENBQUMsQ0FBQTtnQkFDckMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsTUFBTSxDQUFDLHlCQUF5QixDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUE7Z0JBQzFELE9BQU8sRUFBRSxDQUFBO1lBQ1gsQ0FBQztRQUNILENBQUMsQ0FBQyxDQUFBO1FBQ0YsSUFBSSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUE7UUFDdEIsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLEVBQUUsQ0FBQTtJQUNsQixDQUFDLENBQUMsQ0FBQTtBQUNKLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb21wb3NpdGVEaXNwb3NhYmxlLCBUZXh0RWRpdG9yIH0gZnJvbSAnYXRvbSdcbmltcG9ydCAqIGFzIENQIGZyb20gJ2NoaWxkX3Byb2Nlc3MnXG5cbmxldCBzdWJzY3JpcHRpb25zOiBDb21wb3NpdGVEaXNwb3NhYmxlXG5cbmV4cG9ydCBjb25zdCBjb25maWcgPSB7XG4gIGNvbW1hbmQ6IHtcbiAgICB0eXBlOiAnc3RyaW5nJyxcbiAgICBkZWZhdWx0OiAnY2F0JyxcbiAgfSxcbiAgcnVuT25TYXZlOiB7XG4gICAgdHlwZTogJ2Jvb2xlYW4nLFxuICAgIGRlZmF1bHQ6IGZhbHNlLFxuICB9LFxufVxuXG5leHBvcnQgZnVuY3Rpb24gYWN0aXZhdGUoKSB7XG4gIHN1YnNjcmlwdGlvbnMgPSBuZXcgQ29tcG9zaXRlRGlzcG9zYWJsZSgpXG4gIHN1YnNjcmlwdGlvbnMuYWRkKFxuICAgIGF0b20uY29tbWFuZHMuYWRkKCdhdG9tLXRleHQtZWRpdG9yJywge1xuICAgICAgJ3VuaXgtZmlsdGVyOnJ1bic6ICh7IGN1cnJlbnRUYXJnZXQgfSkgPT4ge1xuICAgICAgICBydW4oY3VycmVudFRhcmdldC5nZXRNb2RlbCgpKS5jYXRjaCgoZSkgPT4ge1xuICAgICAgICAgIGNvbnNvbGUuZXJyb3IoZSlcbiAgICAgICAgfSlcbiAgICAgIH0sXG4gICAgICAvLyBUT0RPOiBhdG9tLXNlbGVjdC1saXN0IHdpdGggaGlzdG9yeVxuICAgICAgJ3VuaXgtZmlsdGVyOmV4ZWMnOiBhc3luYyAoeyBjdXJyZW50VGFyZ2V0IH0pID0+IHtcbiAgICAgICAgY29uc3QgdGV4dEVkaXRvckVsZW1lbnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdhdG9tLXRleHQtZWRpdG9yJylcbiAgICAgICAgdGV4dEVkaXRvckVsZW1lbnQuc2V0QXR0cmlidXRlKCdtaW5pJywgJycpXG4gICAgICAgIGNvbnN0IHBhbmVsID0gYXRvbS53b3Jrc3BhY2UuYWRkTW9kYWxQYW5lbCh7XG4gICAgICAgICAgaXRlbTogdGV4dEVkaXRvckVsZW1lbnQsXG4gICAgICAgICAgdmlzaWJsZTogdHJ1ZSxcbiAgICAgICAgfSlcbiAgICAgICAgdGV4dEVkaXRvckVsZW1lbnQuZm9jdXMoKVxuICAgICAgICBjb25zdCBkaXNwID0gbmV3IENvbXBvc2l0ZURpc3Bvc2FibGUoKVxuICAgICAgICBjb25zdCBjb250ID0gYXdhaXQgbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHtcbiAgICAgICAgICBkaXNwLmFkZChcbiAgICAgICAgICAgIGF0b20uY29tbWFuZHMuYWRkKHRleHRFZGl0b3JFbGVtZW50LCB7XG4gICAgICAgICAgICAgICdjb3JlOmNvbmZpcm0nOiAoKSA9PiByZXNvbHZlKHRydWUpLFxuICAgICAgICAgICAgICAnY29yZTpjYW5jZWwnOiAoKSA9PiByZXNvbHZlKGZhbHNlKSxcbiAgICAgICAgICAgIH0pLFxuICAgICAgICAgIClcbiAgICAgICAgfSlcbiAgICAgICAgZGlzcC5kaXNwb3NlKClcbiAgICAgICAgcGFuZWwuZGVzdHJveSgpXG4gICAgICAgIGlmIChjb250KSB7XG4gICAgICAgICAgY29uc3QgY21kID0gdGV4dEVkaXRvckVsZW1lbnQuZ2V0TW9kZWwoKS5nZXRUZXh0KClcbiAgICAgICAgICBjdXN0b21Db21tYW5kKGN1cnJlbnRUYXJnZXQuZ2V0TW9kZWwoKSwgY21kKS5jYXRjaCgoZSkgPT4ge1xuICAgICAgICAgICAgY29uc29sZS5lcnJvcihlKVxuICAgICAgICAgIH0pXG4gICAgICAgIH1cbiAgICAgIH0sXG4gICAgfSksXG4gICAgYXRvbS53b3Jrc3BhY2Uub2JzZXJ2ZVRleHRFZGl0b3JzKChlZGl0b3IpID0+IHtcbiAgICAgIGNvbnN0IGJ1ZiA9IGVkaXRvci5nZXRCdWZmZXIoKVxuICAgICAgY29uc3QgZGlzcCA9IGJ1Zi5vbldpbGxTYXZlKGFzeW5jICgpID0+IHtcbiAgICAgICAgY29uc3Qgc2hvdWxkUnVuID0gYXRvbS5jb25maWcuZ2V0KCd1bml4LWZpbHRlci5ydW5PblNhdmUnLCB7XG4gICAgICAgICAgc2NvcGU6IGVkaXRvci5nZXRMYXN0Q3Vyc29yKCkuZ2V0U2NvcGVEZXNjcmlwdG9yKCksXG4gICAgICAgIH0pXG4gICAgICAgIGlmIChzaG91bGRSdW4pIHJldHVybiBydW4oZWRpdG9yKVxuICAgICAgICBlbHNlIHJldHVyblxuICAgICAgfSlcbiAgICAgIGJ1Zi5vbkRpZERlc3Ryb3koKCkgPT4ge1xuICAgICAgICBzdWJzY3JpcHRpb25zLnJlbW92ZShkaXNwKVxuICAgICAgICBkaXNwLmRpc3Bvc2UoKVxuICAgICAgfSlcbiAgICB9KSxcbiAgKVxufVxuXG5leHBvcnQgZnVuY3Rpb24gZGVhY3RpdmF0ZSgpIHtcbiAgc3Vic2NyaXB0aW9ucy5kaXNwb3NlKClcbn1cblxuYXN5bmMgZnVuY3Rpb24gcnVuKGVkaXRvcjogVGV4dEVkaXRvcikge1xuICBjb25zdCBjbWQgPSBhdG9tLmNvbmZpZy5nZXQoJ3VuaXgtZmlsdGVyLmNvbW1hbmQnLCB7XG4gICAgc2NvcGU6IGVkaXRvci5nZXRMYXN0Q3Vyc29yKCkuZ2V0U2NvcGVEZXNjcmlwdG9yKCksXG4gIH0pXG4gIHJldHVybiBjdXN0b21Db21tYW5kKGVkaXRvciwgY21kKVxufVxuXG5hc3luYyBmdW5jdGlvbiBjdXN0b21Db21tYW5kKGVkaXRvcjogVGV4dEVkaXRvciwgY21kOiBzdHJpbmcpIHtcbiAgY29uc3QgdGV4dCA9IGVkaXRvci5nZXRUZXh0KClcbiAgcmV0dXJuIG5ldyBQcm9taXNlPHZvaWQ+KChyZXNvbHZlKSA9PiB7XG4gICAgY29uc3QgcHJvYyA9IENQLmV4ZWMoY21kLCB7IGVuY29kaW5nOiAndXRmOCcgfSwgKGVycm9yLCByZXN1bHQpID0+IHtcbiAgICAgIGlmIChlcnJvcikge1xuICAgICAgICBhdG9tLm5vdGlmaWNhdGlvbnMuYWRkRXJyb3IoZXJyb3IudG9TdHJpbmcoKSwge1xuICAgICAgICAgIGRldGFpbDogZXJyb3IubWVzc2FnZSxcbiAgICAgICAgICBzdGFjazogZXJyb3Iuc3RhY2ssXG4gICAgICAgICAgZGlzbWlzc2FibGU6IHRydWUsXG4gICAgICAgIH0pXG4gICAgICAgIHJlc29sdmUoKSAvLyBhbHdheXMgc2F2ZSB0aGUgZmlsZSFcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGNvbnN0IFtmaXJzdCwgLi4ucG9pbnRzXSA9IGVkaXRvclxuICAgICAgICAgIC5nZXRDdXJzb3JzKClcbiAgICAgICAgICAubWFwKChjKSA9PiBjLmdldEJ1ZmZlclBvc2l0aW9uKCkpXG4gICAgICAgIGVkaXRvci5zZXRUZXh0KHJlc3VsdC5yZXBsYWNlKC9eICskL2dtLCAnJykpXG4gICAgICAgIGVkaXRvci5zZXRDdXJzb3JCdWZmZXJQb3NpdGlvbihmaXJzdClcbiAgICAgICAgcG9pbnRzLmZvckVhY2goKHApID0+IGVkaXRvci5hZGRDdXJzb3JBdEJ1ZmZlclBvc2l0aW9uKHApKVxuICAgICAgICByZXNvbHZlKClcbiAgICAgIH1cbiAgICB9KVxuICAgIHByb2Muc3RkaW4ud3JpdGUodGV4dClcbiAgICBwcm9jLnN0ZGluLmVuZCgpXG4gIH0pXG59XG4iXX0=